WITH case_data AS(

    SELECT CASES.ID AS CASE_ID,
       CASES.CASE_NUMBER,
       CASES.TYPE AS CASE_TYPE,
       --CASES.SUB_TYPE AS CASE_SUB_TYPE,
       CASES.ZENDESK_CASE_ORIGIN_C,
       ROUTING.ID AS ROUTING_ID,
       ROUTING.OWNER_ID,
       ROUTING.CREATED_DATE,
       ROUTING.LAST_MODIFIED_DATE,
       ROUTING.WORK_ITEM_ID,
       ROUTING.IS_DELETED AS ROUTING_IS_DELETED,
       ROUTING.IS_TRANSFER,
       SKILL_REQ.RELATED_RECORD_ID,
       SKILL_REQ.ID AS SKILL_REQ_ID,
       SKILL_REQ.SKILL_NUMBER,
       SKILL.MASTER_LABEL,
       SKILL.LANGUAGE,
       SKILL_REQ.SKILL_ID,
       SKILL_REQ.IS_ADDITIONAL_SKILL,
       CASES.SUPPLIED_NAME,
       CASES.SUPPLIED_EMAIL,
       CASES.CONTACT_PHONE,
       1 AS FOR_COUNT


    FROM GUILD.SALESFORCE_CLOUD.PENDING_SERVICE_ROUTING AS ROUTING
    LEFT JOIN GUILD.SALESFORCE_CLOUD.CASE AS CASES ON ROUTING.WORK_ITEM_ID = CASES.ID
    LEFT JOIN GUILD.SALESFORCE_CLOUD.SKILL_REQUIREMENT AS SKILL_REQ ON ROUTING.ID = SKILL_REQ.RELATED_RECORD_ID
    LEFT JOIN GUILD.SALESFORCE_CLOUD.SKILL AS SKILL ON SKILL.ID = SKILL_REQ.SKILL_ID)

SELECT
    CREATED_DATE,
    LAST_MODIFIED_DATE,
    CASE_ID,
    CASE_NUMBER,
    LISTAGG(MASTER_LABEL,', ') AS ALL_SKILL_NAMES,
    (CASE WHEN ALL_SKILL_NAMES LIKE '%Member Resolution%' THEN 'Member Resolution' ELSE ALL_SKILL_NAMES END) AS CUSTOM_SKILL_GROUP,
    CASE_TYPE,
    --IS_TRANSFER,
    ROUTING_ID,
    OWNER_ID,
    ZENDESK_CASE_ORIGIN_C,
    SUPPLIED_NAME,
    SUPPLIED_EMAIL,
    CONTACT_PHONE
    ROUTING_IS_DELETED,
    WORK_ITEM_ID,
    RELATED_RECORD_ID,
    LISTAGG(IS_ADDITIONAL_SKILL,', ') AS ALL_IS_ADDITIONAL_SKILL,
    LISTAGG(RELATED_RECORD_ID,', ') AS ALL_RELATED_RECORD_ID,
    LISTAGG(SKILL_REQ_ID,', ') AS ALL_SKILL_REQ_ID,
    LISTAGG(SKILL_NUMBER,', ') AS ALL_SKILL_NUMBER,
    LISTAGG(LANGUAGE,', ') AS ALL_LANGUAGE,
    LISTAGG(SKILL_ID,', ') AS ALL_SKILL_ID



    --SUM(FOR_COUNT) OVER (PARTITION BY CASE_ID) TOTAL_SKILL_BY_CASE
FROM case_data
--WHERE routing_is_deleted = false --AND case_number = '05306491'.  <--- Use this to filter for backlog
GROUP BY 1,2,3,4,7,8,9,10,11,12,13,14,15
